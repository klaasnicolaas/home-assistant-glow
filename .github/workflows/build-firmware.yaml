---
# Build ESPHome firmwares for the Home Assistant Glow project.
name: Build firmware

on:
  push:
    branches:
      - develop
      - release/**
    paths:
      - home-assistant-glow/**
      - glow-basic/**
      - components/**
      - .github/workflows/**
  workflow_dispatch:
  workflow_call:
    inputs:
      release-url:
        required: true
        type: string
      release-summary:
        required: false
        type: string
        default: "Check the release notes for more information."
  pull_request:
    branches-ignore:
      - renovate/docusaurus**
    paths:
      - home-assistant-glow/**
      - glow-basic/**
      - components/**
      - .github/workflows/**
  # Every Monday at 4:00 UTC
  schedule:
    - cron: "0 4 * * 1"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  RELEASE_URL: ${{ github.server_url }}/${{ github.repository }}/releases/latest

jobs:
  build:
    name: ${{ matrix.device }} / ${{ matrix.variant }}
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 5
      fail-fast: false
      matrix:
        device: [esp32, esp32c3, esp8266]
        variant: [standard, basic]
        include:
          - variant: standard
            folder: home-assistant-glow
          - variant: basic
            folder: glow-basic
    steps:
      - name: ‚§µÔ∏è Check out code from GitHub
        uses: actions/checkout@v6.0.2
      - name: üîß Set build variables
        id: vars
        run: |
          echo "suffix=${{ matrix.device }}" >> $GITHUB_OUTPUT
          echo "yaml=${{ matrix.folder }}/${{ matrix.device }}.yaml" >> $GITHUB_OUTPUT
      - name: üîç Update ESPHome package ref for dev/PR builds
        if: ${{ !contains(fromJSON('["release", "workflow_call"]'), github.event_name) }}
        env:
          HEAD_REF: ${{ github.head_ref || github.ref_name }}
          PR_HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
          REPO: ${{ github.repository }}
          YAML_FILE: ${{ steps.vars.outputs.yaml }}
        run: |
          sed -i "s|ref: .*|ref: \"${HEAD_REF}\"|g" "$YAML_FILE"
          if [ "$PR_HEAD_REPO" != "$REPO" ] && [ -n "$PR_HEAD_REPO" ]; then
            echo "Updating repository URL for fork: $PR_HEAD_REPO"
            sed -i "s|^\([[:space:]]*\)url: https://github.com/${REPO}/|\1url: https://github.com/${PR_HEAD_REPO}/|g" "$YAML_FILE"
          fi
      - name: üî® Build firmware
        uses: esphome/build-action@v7.1.0
        id: esphome-build
        with:
          yaml-file: ${{ steps.vars.outputs.yaml }}
          version: latest
          release-summary: ${{ inputs.release-summary || 'Check the release notes for more information.' }}
          release-url: ${{ inputs.release-url || env.RELEASE_URL }}
      - name: üöö Prepare output artifacts
        run: |
          set -e
          SUFFIX="${{ steps.vars.outputs.suffix }}"
          mkdir -p output/$SUFFIX
          mv ${{ steps.esphome-build.outputs.name }}/* output/$SUFFIX/
          echo "${{ steps.esphome-build.outputs.version }}" > output/$SUFFIX/version
          echo "${{ steps.esphome-build.outputs.project-version }}" > output/$SUFFIX/project_version
          sed -i "s|${{ steps.esphome-build.outputs.name }}\(\.[a-z]*\)\.bin|/${{ matrix.folder }}/$SUFFIX/${{ steps.esphome-build.outputs.name }}\1.bin|" output/$SUFFIX/manifest.json
          jq --arg variant "${{ matrix.variant }}" '. + {variant: $variant}' output/$SUFFIX/manifest.json > output/$SUFFIX/manifest.json.tmp
          mv output/$SUFFIX/manifest.json.tmp output/$SUFFIX/manifest.json

      - name: ‚¨ÜÔ∏è Upload firmware artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: build-glow-${{ matrix.variant }}-${{ matrix.device }}
          path: output
          retention-days: 7

  comment:
    name: Comment on PR
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pull-requests: write
    steps:
      - name: üí¨ Comment on PR
        uses: actions/github-script@v8.0.0
        with:
          script: |
            // Get all artifacts from this workflow run
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            let comment = '## üéâ Firmware built successfully!\n\n';
            comment += 'Download the firmware for your device and flash it using [ESPHome Web](https://web.esphome.io):\n\n';

            // Collect artifacts by device and variant
            const devices = {};
            artifacts.data.artifacts.forEach(artifact => {
              if (artifact.name.startsWith('build-glow-')) {
                // Artifact name format: build-glow-{variant}-{device}
                const parts = artifact.name.replace('build-glow-', '').split('-');
                const variant = parts[0];
                const device = parts.slice(1).join('-');
                const downloadUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}/artifacts/${artifact.id}`;
                if (!devices[device]) devices[device] = {};
                devices[device][variant] = downloadUrl;
              }
            });

            // Build markdown table
            comment += '| Device | Standard | Basic |\n';
            comment += '|--------|----------|-------|\n';
            for (const [device, variants] of Object.entries(devices)) {
              const standard = variants.standard ? `[Download](${variants.standard})` : '-';
              const basic = variants.basic ? `[Download](${variants.basic})` : '-';
              comment += `| **${device}** | ${standard} | ${basic} |\n`;
            }

            comment += '\n### üìù Installation instructions\n';
            comment += '1. Download and extract the ZIP file for your device\n';
            comment += '2. Use the **factory.bin** file for a fresh install via [ESPHome Web](https://web.esphome.io)\n';
            comment += '3. For OTA updates, you can use the other `.bin` files\n';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
