---
# Build ESPHome firmwares for the Home Assistant Glow project.
name: Build firmware

on:
  push:
    branches:
      - develop
      - release/**
  workflow_dispatch:
  workflow_call:
    inputs:
      release-url:
        required: true
        type: string
  pull_request:
    branches-ignore:
      - renovate/docusaurus**
  # Every Monday at 4:00 UTC
  schedule:
    - cron: "0 4 * * 1"

concurrency:
  # yamllint disable-line rule:line-length
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  RELEASE_URL: ${{ github.server_url }}/${{ github.repository }}/releases/latest

jobs:
  build:
    name: ${{ matrix.device }}
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 5
      fail-fast: false
      matrix:
        device: [esp32, esp32c3, esp8266]
    steps:
      - name: ‚§µÔ∏è Check out code from GitHub
        uses: actions/checkout@v6.0.1
      - name: üîç Update ESPHome package ref for dev/PR builds
        if: ${{ !contains(fromJSON('["release", "workflow_call"]'), github.event_name) }}
        run: |
          # Update the ref in YAML to point to current branch for testing
          sed -i "s|ref: .*|ref: \"${{ github.head_ref || github.ref_name }}\"|g" home-assistant-glow/${{ matrix.device }}.yaml

          # For PRs from forks, also update the repository URL
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ] && [ -n "${{ github.event.pull_request.head.repo.full_name }}" ]; then
            echo "Updating repository URL for fork: ${{ github.event.pull_request.head.repo.full_name }}"
            sed -i "s|^\([[:space:]]*\)url: https://github.com/${{ github.repository }}/|\1url: https://github.com/${{ github.event.pull_request.head.repo.full_name }}/|g" home-assistant-glow/${{ matrix.device }}.yaml
          fi
      - name: üî® Build firmware
        uses: esphome/build-action@v7.1.0
        id: esphome-build
        with:
          yaml-file: home-assistant-glow/${{ matrix.device }}.yaml
          version: latest
          release-summary: "Check the release notes for more information."
          release-url: ${{ inputs.release-url || env.RELEASE_URL }}
      - name: üöö Prepare output artifacts
        run: |
          # Create output directory structure
          mkdir -p output/${{ matrix.device }}
          mv ${{ steps.esphome-build.outputs.name }}/* output/${{ matrix.device }}/

          # Save version information
          echo ${{ steps.esphome-build.outputs.version }} > output/${{ matrix.device }}/version
          echo ${{ steps.esphome-build.outputs.project-version }} > output/${{ matrix.device }}/project_version

          # Update manifest.json paths for web deployment
          sed -i 's|${{ steps.esphome-build.outputs.name }}\(\.[a-z]*\)\.bin|/home-assistant-glow/${{ matrix.device }}/${{ steps.esphome-build.outputs.name }}\1.bin|' output/${{ matrix.device }}/manifest.json
      - name: ‚¨ÜÔ∏è Upload firmware artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: build-home-assistant-glow-${{ matrix.device }}
          path: output
          retention-days: 7

  comment:
    name: Comment on PR
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pull-requests: write
    steps:
      - name: üí¨ Comment on PR
        uses: actions/github-script@v8.0.0
        with:
          script: |
            // Get all artifacts from this workflow run
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            let comment = '## üéâ Firmware built successfully!\n\n';
            comment += 'Download the firmware for your device and flash it using [ESPHome Web](https://web.esphome.io):\n\n';

            // Create download links for each device artifact
            artifacts.data.artifacts.forEach(artifact => {
              if (artifact.name.startsWith('build-home-assistant-glow-')) {
                const device = artifact.name.replace('build-home-assistant-glow-', '');
                const downloadUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}/artifacts/${artifact.id}`;
                comment += `- **${device}**: [Download](${downloadUrl})\n`;
              }
            });

            comment += '\n### üìù Installation instructions\n';
            comment += '1. Download and extract the ZIP file for your device\n';
            comment += '2. Use the **factory.bin** file for a fresh install via [ESPHome Web](https://web.esphome.io)\n';
            comment += '3. For OTA updates, you can use the other `.bin` files\n';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
