---
# Build ESPHome firmwares for the Home Assistant Glow project.
name: Build firmware

on:
  push:
    branches:
      - develop
      - release/**
  workflow_dispatch:
  workflow_call:
    inputs:
      release-url:
        required: true
        type: string
  pull_request:
    branches-ignore:
      - renovate/docusaurus**
  # Every Monday at 4:00 UTC
  schedule:
    - cron: "0 4 * * 1"

concurrency:
  # yamllint disable-line rule:line-length
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  RELEASE_URL: ${{ github.server_url }}/${{ github.repository }}/releases/latest

jobs:
  build:
    name: ${{ matrix.device }}
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 5
      fail-fast: false
      matrix:
        device: [esp32, esp8266]
    steps:
      - name: ‚§µÔ∏è Check out code from GitHub
        uses: actions/checkout@v6.0.1
      - name: üîç Update ESPHome package ref for dev/PR builds
        if: ${{ !contains(fromJSON('["release", "workflow_call"]'), github.event_name) }}
        run: |
          # Update the ref in YAML to point to current branch for testing
          sed -i "s|ref: .*|ref: \"${{ github.head_ref || github.ref_name }}\"|g" home-assistant-glow/${{ matrix.device }}.yaml
      - name: üî® Build firmware
        uses: esphome/build-action@v7.1.0
        id: esphome-build
        with:
          yaml-file: home-assistant-glow/${{ matrix.device }}.yaml
          version: latest
          release-summary: "Check the release notes for more information."
          release-url: ${{ inputs.release-url || env.RELEASE_URL }}
      - name: üöö Prepare output artifacts
        run: |
          # Create output directory structure
          mkdir -p output/${{ matrix.device }}
          mv ${{ steps.esphome-build.outputs.name }}/* output/${{ matrix.device }}/

          # Save version information
          echo ${{ steps.esphome-build.outputs.version }} > output/${{ matrix.device }}/version
          echo ${{ steps.esphome-build.outputs.project-version }} > output/${{ matrix.device }}/project_version

          # Update manifest.json paths for web deployment
          sed -i 's|${{ steps.esphome-build.outputs.name }}\(\.[a-z]*\)\.bin|/home-assistant-glow/${{ matrix.device }}/${{ steps.esphome-build.outputs.name }}\1.bin|' output/${{ matrix.device }}/manifest.json
      - name: ‚¨ÜÔ∏è Upload firmware artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: build-home-assistant-glow-${{ matrix.device }}
          path: output
          retention-days: 1

  comment:
    name: Comment on PR
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pull-requests: write
    steps:
      - name: üì• Download artifacts
        uses: actions/download-artifact@v7.0.0
        with:
          path: artifacts
      - name: üí¨ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const artifacts = fs.readdirSync('artifacts');

            let comment = '## üéâ Firmware built successfully!\n\n';
            comment += 'You can test the firmware by downloading the artifacts:\n\n';

            artifacts.forEach(artifact => {
              const device = artifact.replace('build-home-assistant-glow-', '');
              comment += `- **${device}**: [Download artifact](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
            });

            comment += '\n### üìù Installation instructions\n';
            comment += '1. Download the artifact for your device\n';
            comment += '2. Extract the ZIP file\n';
            comment += '3. Use [ESPHome Web](https://web.esphome.io) to upload the firmware\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
