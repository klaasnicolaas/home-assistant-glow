---
# Comment on PR after firmware build completes
name: PR Comment

on:
  workflow_run:
    workflows: ["Build firmware"]
    types:
      - completed

permissions:
  pull-requests: write
  issues: write
  actions: read

jobs:
  comment:
    name: Comment on PR
    # Only run if the workflow run was triggered by a pull request and succeeded
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: üí¨ Comment on PR
        uses: actions/github-script@v8.0.0
        with:
          script: |
            // Get the PR number from the workflow run
            const prNumber = github.event.workflow_run.pull_requests[0]?.number;
            if (!prNumber) {
              console.log('No PR found for this workflow run');
              return;
            }

            // Get all artifacts from the workflow run
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: github.event.workflow_run.id,
            });

            let comment = '## üéâ Firmware built successfully!\n\n';
            comment += 'Download the firmware for your device and flash it using [ESPHome Web](https://web.esphome.io):\n\n';

            // Create download links for each device artifact
            artifacts.data.artifacts.forEach(artifact => {
              if (artifact.name.startsWith('build-home-assistant-glow-')) {
                const device = artifact.name.replace('build-home-assistant-glow-', '');
                const downloadUrl = `${context.payload.repository.html_url}/actions/runs/${github.event.workflow_run.id}/artifacts/${artifact.id}`;
                comment += `- **${device}**: [Download](${downloadUrl})\n`;
              }
            });

            comment += '\n### üìù Installation instructions\n';
            comment += '1. Download and extract the ZIP file for your device\n';
            comment += '2. Use the **factory.bin** file for a fresh install via [ESPHome Web](https://web.esphome.io)\n';
            comment += '3. For OTA updates, you can use the other `.bin` files\n';

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
