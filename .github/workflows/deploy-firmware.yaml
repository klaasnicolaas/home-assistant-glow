---
# Build & Deploy the ESPHome firmwares for the Home Assistant Glow project.
name: Deploy firmware

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      release-url:
        description: "Release URL"
        required: true
        type: string
      release-summary:
        description: "Release summary/notes"
        required: false
        type: string

jobs:
  build-firmware:
    name: Build firmware
    uses: klaasnicolaas/home-assistant-glow/.github/workflows/build-firmware.yaml@main
    with:
      release-url: ${{ github.event.release.html_url || inputs.release-url }}
      release-summary: ${{ github.event.release.body || inputs.release-summary }}

  combined-manifests:
    name: Organize ${{ matrix.folder }} firmware
    runs-on: ubuntu-latest
    needs: build-firmware
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: standard
            folder: home-assistant-glow
            name: Home Assistant Glow
            pattern: build-glow-standard-*
          - variant: basic
            folder: glow-basic
            name: Home Assistant Glow (basic)
            pattern: build-glow-basic-*
    steps:
      - name: â¤µï¸ Download variant artifacts
        uses: actions/download-artifact@v7.0.0
        with:
          pattern: ${{ matrix.pattern }}
          merge-multiple: true
          path: ${{ matrix.folder }}
      - name: ğŸ”¨ Generate combined manifest
        run: |
          cd ${{ matrix.folder }}
          version=$(cat */project_version | head -n 1)

          jq -s --arg name "${{ matrix.name }}" --arg version "$version" '{
            name: $name,
            version: $version,
            home_assistant_domain: "esphome",
            builds: .
          }' */manifest.json > manifest.json
      - name: ğŸ§ª Display structure
        run: ls -R ${{ matrix.folder }}
      - name: â¬†ï¸ Upload organized artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: ${{ matrix.folder }}
          path: ${{ matrix.folder }}
          retention-days: 1

  build-docs:
    name: Build documentation
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    needs: combined-manifests
    steps:
      - name: â¤µï¸ Check out code from GitHub
        uses: actions/checkout@v6.0.2
      - name: â¬‡ï¸ Download firmware artifacts
        uses: actions/download-artifact@v7.0.0
        with:
          pattern: "*glow*"
          path: docs/static
      - name: ğŸ§ª Display structure of job
        run: ls -R docs/static
      - name: ğŸ—ï¸ Set up Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 24.x
          cache: npm
          cache-dependency-path: docs/package-lock.json
      - name: ğŸ—ï¸ Install Docusaurus dependencies
        run: npm ci
        working-directory: docs
      - name: ğŸš€ Build Docusaurus
        run: npm run build
        working-directory: docs
      - name: â¬†ï¸ Upload pages artifacts
        uses: actions/upload-pages-artifact@v4.0.0
        with:
          path: docs/build

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ğŸ—ï¸ Setup Github Pages
        uses: actions/configure-pages@v5.0.0
      - name: ğŸš€ Deploy to Github Pages
        uses: actions/deploy-pages@v4.0.5
        id: deployment
